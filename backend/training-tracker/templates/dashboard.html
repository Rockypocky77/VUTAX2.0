<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VUTAX 2.0 - AI Training Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .progress-bar { 
            transition: width 0.5s ease-in-out;
            background: linear-gradient(90deg, #4ade80, #22c55e);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="text-center text-white mb-8">
            <h1 class="text-4xl font-bold mb-2">ðŸ¤– VUTAX 2.0 AI Training Dashboard</h1>
            <p class="text-xl opacity-90">Real-time monitoring of data fetching and model training</p>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Overall Progress -->
            <div class="lg:col-span-2 bg-white rounded-xl p-6 shadow-lg card-hover">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <span class="pulse-dot w-3 h-3 bg-green-500 rounded-full mr-3" id="statusDot"></span>
                    Training Progress
                </h2>
                
                <!-- Overall Progress Bar -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-medium" id="stageText">Ready to start</span>
                        <span class="text-sm font-medium" id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="progress-bar h-4 rounded-full" id="overallProgress" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2 text-sm text-gray-600" id="etaText">ETA: --</div>
                </div>

                <!-- Stage Progress Bars -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>ðŸ“Š Data Collection</span>
                                <span id="dataCollectionPercent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-500" id="dataCollectionBar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>ðŸ”§ Feature Engineering</span>
                                <span id="featureEngPercent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-yellow-500 h-2 rounded-full transition-all duration-500" id="featureEngBar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>ðŸ¤– Model Training</span>
                                <span id="modelTrainingPercent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-500 h-2 rounded-full transition-all duration-500" id="modelTrainingBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>âœ… Validation</span>
                                <span id="validationPercent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-500" id="validationBar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>ðŸš€ Deployment</span>
                                <span id="deploymentPercent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-indigo-500 h-2 rounded-full transition-all duration-500" id="deploymentBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex gap-3 mt-6">
                    <button onclick="startTraining()" id="startBtn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all">
                        Start Training
                    </button>
                    <button onclick="stopTraining()" id="stopBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-all" disabled>
                        Stop Training
                    </button>
                    <select id="modelSelect" class="border border-gray-300 rounded-lg px-3 py-2">
                        <option value="analytical">Analytical Model</option>
                        <option value="chatbot">Chatbot Model</option>
                    </select>
                </div>
            </div>

            <!-- Data Fetching Stats -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
                <h2 class="text-xl font-bold mb-4">ðŸ“Š Data Fetching</h2>
                
                <div class="space-y-4">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600" id="articlesCount">0</div>
                        <div class="text-sm text-gray-600">Articles Fetched</div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-500" id="articlesProgress" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1" id="articlesTarget">Target: 1000</div>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="stocksCount">0</div>
                        <div class="text-sm text-gray-600">Stocks Processed</div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div class="bg-green-500 h-2 rounded-full transition-all duration-500" id="stocksProgress" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1" id="stocksTarget">Target: 100</div>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600" id="dataPointsCount">0</div>
                        <div class="text-sm text-gray-600">Data Points</div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div class="bg-purple-500 h-2 rounded-full transition-all duration-500" id="dataPointsProgress" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1" id="dataPointsTarget">Target: 50K</div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <div class="text-sm text-gray-600 mb-2">Current Source:</div>
                        <div class="font-semibold" id="currentSource">--</div>
                        
                        <div class="text-sm text-gray-600 mt-3 mb-2">Fetch Rate:</div>
                        <div class="font-semibold" id="fetchRate">0 articles/min</div>
                        
                        <div class="text-sm text-gray-600 mt-3 mb-2">Errors:</div>
                        <div class="font-semibold text-red-600" id="errorCount">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Data Fetching Chart -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
                <h2 class="text-xl font-bold mb-4">ðŸ“ˆ Data Fetching Progress</h2>
                <div class="chart-container">
                    <canvas id="dataFetchingChart"></canvas>
                </div>
            </div>

            <!-- Model Performance Chart -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
                <h2 class="text-xl font-bold mb-4">ðŸŽ¯ Model Performance</h2>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Training Logs -->
        <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
            <h2 class="text-xl font-bold mb-4">ðŸ“‹ Training Logs</h2>
            <div class="bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm" id="logsContainer">
                <div class="text-green-400">[System] Training dashboard initialized. Ready to monitor ML training progress.</div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();
        
        // Chart instances
        let dataFetchingChart;
        let performanceChart;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            refreshStatus();
        });

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to training tracker');
            addLog('Connected to training tracker', 'success');
        });

        socket.on('training_update', function(data) {
            updateTrainingStatus(data);
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from training tracker');
            addLog('Disconnected from training tracker', 'warning');
        });

        // Training control functions
        function startTraining() {
            const modelType = document.getElementById('modelSelect').value;
            
            fetch('/api/start-training', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ model_type: modelType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    addLog('Error: ' + data.error, 'error');
                } else {
                    addLog(data.message, 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addLog('Failed to start training', 'error');
            });
        }

        function stopTraining() {
            fetch('/api/stop-training', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                addLog(data.message, 'info');
            })
            .catch(error => {
                console.error('Error:', error);
                addLog('Failed to stop training', 'error');
            });
        }

        function refreshStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateTrainingStatus(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Update UI functions
        function updateTrainingStatus(data) {
            const isTraining = data.is_training;
            const progress = data.progress || 0;
            const stage = data.current_stage || 'idle';
            
            // Update overall progress
            document.getElementById('overallProgress').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
            document.getElementById('stageText').textContent = getStageMessage(stage);
            
            // Update ETA
            if (data.eta_minutes > 0) {
                document.getElementById('etaText').textContent = `ETA: ${data.eta_minutes} minutes`;
            } else {
                document.getElementById('etaText').textContent = 'ETA: --';
            }
            
            // Update status indicator
            const statusDot = document.getElementById('statusDot');
            if (isTraining) {
                statusDot.className = 'pulse-dot w-3 h-3 bg-yellow-500 rounded-full mr-3';
            } else if (progress === 100) {
                statusDot.className = 'pulse-dot w-3 h-3 bg-green-500 rounded-full mr-3';
            } else {
                statusDot.className = 'pulse-dot w-3 h-3 bg-gray-500 rounded-full mr-3';
            }
            
            // Update stage progress bars
            if (data.stage_progress) {
                updateStageProgress(data.stage_progress);
            }
            
            // Update data fetching metrics
            if (data.data_fetching) {
                updateDataFetching(data.data_fetching);
            }
            
            // Update button states
            document.getElementById('startBtn').disabled = isTraining;
            document.getElementById('stopBtn').disabled = !isTraining;
            
            // Update charts
            updateCharts(data);
        }

        function updateStageProgress(stageProgress) {
            const stages = ['data_collection', 'feature_engineering', 'model_training', 'validation', 'deployment'];
            
            stages.forEach(stage => {
                const progress = stageProgress[stage] || 0;
                const bar = document.getElementById(stage.replace('_', '') + 'Bar');
                const percent = document.getElementById(stage.replace('_', '') + 'Percent');
                
                if (bar && percent) {
                    bar.style.width = progress + '%';
                    percent.textContent = Math.round(progress) + '%';
                }
            });
        }

        function updateDataFetching(dataFetching) {
            // Articles
            document.getElementById('articlesCount').textContent = dataFetching.articles_fetched || 0;
            const articlesPercent = ((dataFetching.articles_fetched || 0) / (dataFetching.target_articles || 1000)) * 100;
            document.getElementById('articlesProgress').style.width = articlesPercent + '%';
            
            // Stocks
            document.getElementById('stocksCount').textContent = dataFetching.stocks_processed || 0;
            const stocksPercent = ((dataFetching.stocks_processed || 0) / (dataFetching.target_stocks || 100)) * 100;
            document.getElementById('stocksProgress').style.width = stocksPercent + '%';
            
            // Data Points
            const dataPoints = dataFetching.data_points || 0;
            document.getElementById('dataPointsCount').textContent = formatNumber(dataPoints);
            const dataPointsPercent = (dataPoints / (dataFetching.target_data_points || 50000)) * 100;
            document.getElementById('dataPointsProgress').style.width = dataPointsPercent + '%';
            
            // Other metrics
            document.getElementById('currentSource').textContent = dataFetching.current_source || '--';
            document.getElementById('fetchRate').textContent = Math.round(dataFetching.fetch_rate || 0) + ' articles/min';
            document.getElementById('errorCount').textContent = dataFetching.errors || 0;
        }

        function updateCharts(data) {
            // Update data fetching chart
            if (data.data_fetching && data.data_fetching.progress_history) {
                updateDataFetchingChart(data.data_fetching.progress_history);
            }
            
            // Update performance chart
            if (data.metrics) {
                updatePerformanceChart(data.metrics);
            }
        }

        function updateDataFetchingChart(progressHistory) {
            if (!dataFetchingChart || progressHistory.length === 0) return;
            
            const labels = progressHistory.map(p => p.timestamp);
            const articlesData = progressHistory.map(p => p.articles);
            const stocksData = progressHistory.map(p => p.stocks);
            const dataPointsData = progressHistory.map(p => p.data_points / 1000); // Scale down for chart
            
            dataFetchingChart.data.labels = labels;
            dataFetchingChart.data.datasets[0].data = articlesData;
            dataFetchingChart.data.datasets[1].data = stocksData;
            dataFetchingChart.data.datasets[2].data = dataPointsData;
            
            dataFetchingChart.update('none');
        }

        function updatePerformanceChart(metrics) {
            if (!performanceChart) return;
            
            const now = new Date().toLocaleTimeString();
            
            // Add new data point
            performanceChart.data.labels.push(now);
            performanceChart.data.datasets[0].data.push((metrics.analytical_model?.accuracy || 0) * 100);
            performanceChart.data.datasets[1].data.push((metrics.chatbot_model?.quality_score || 0) * 100);
            
            // Keep only last 10 data points
            if (performanceChart.data.labels.length > 10) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets[0].data.shift();
                performanceChart.data.datasets[1].data.shift();
            }
            
            performanceChart.update('none');
        }

        function initializeCharts() {
            // Data Fetching Chart
            const dataCtx = document.getElementById('dataFetchingChart').getContext('2d');
            dataFetchingChart = new Chart(dataCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Articles Fetched',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Stocks Processed',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Data Points (K)',
                        data: [],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });

            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Analytical Accuracy (%)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Chatbot Quality (%)',
                        data: [],
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById('logsContainer');
            const timestamp = new Date().toLocaleTimeString();
            
            const colors = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'warning': 'text-yellow-400',
                'error': 'text-red-400'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type] || 'text-gray-400';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // Keep only last 50 log entries
            const logs = logsContainer.children;
            if (logs.length > 50) {
                logs[0].remove();
            }
        }

        function getStageMessage(stage) {
            const messages = {
                'collecting_data': 'ðŸ“Š Collecting training data',
                'feature_engineering': 'ðŸ”§ Engineering features',
                'training': 'ðŸ¤– Training model',
                'validation': 'âœ… Validating model',
                'deployment': 'ðŸš€ Deploying model',
                'completed': 'ðŸŽ‰ Training completed',
                'error': 'âŒ Training failed',
                'idle': 'ðŸ’¤ Ready to start training'
            };
            return messages[stage] || 'Processing...';
        }

        function formatNumber(num) {
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Auto-refresh every 10 seconds
        setInterval(refreshStatus, 10000);
    </script>
</body>
</html>
